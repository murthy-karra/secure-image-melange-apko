contents:
  repositories:
    - https://packages.wolfi.dev/os
    - ./packages
  keyring:
    - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    - build/melange.rsa.pub

  packages:
    # --- The Distroless Base ---
    # We DO NOT install wolfi-base (which contains busybox/shell)
    - ca-certificates-bundle
    - tzdata                 # Timezone data is often needed by logs
    - glibc-locale-posix     # Minimal locale support
    
    # Minimal Python Runtime (No pip, no development tools)
    - python-3.12-base
    
    # Your compiled application
    - fastapi-app@local

environment:
  # --- Runtime Path Configuration ---
  # Since we don't have a shell to source "activate", we must 
  # manually tell Python where the venv packages are.
  
  # Point directly to the venv site-packages inside the container
  PYTHONPATH: "/app/venv/lib/python3.12/site-packages:/app"
  
  # Add the venv bin to path (in case main.py calls subprocesses)
  PATH: "/app/venv/bin:/usr/bin:/bin"
  
  # Python Optimizations
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"
  
  # App Configuration
  PORT: "8000"
  LOG_LEVEL: "info"

accounts:
  run-as: "appuser"
  users:
    - username: appuser
      uid: 1001
      gid: 1001
      shell: /bin/false # Redundant as there is no shell, but good practice

# --- The "No Shell" Entrypoint ---
# We invoke the binary directly. 
# There is no /bin/sh or /bin/bash in this image.
# Corrected entrypoint for apko.yaml
entrypoint:
  command: /usr/bin/python3.12 -m uvicorn main:app --host 0.0.0.0 --port 8000

archs:
  - x86_64